{% extends "base.html" %}

{% block bodysections %}

<!-- Event Name / Basic Settings -->
<section class="section">
    <div class="block">
        <h2 class="subtitle">Event Settings</h2>
    </div>
    <div class="block">
        <p>
            <input class="input" type="text" id="gscrl_event_name" value="{{ arena_settings.event_name }}" placeholder="Event Name">
        </p>
    </div>
    <div class="block">
        <p>
            <input class="input" type="text" id="gscrl_event_league" value="{{ arena_settings.event_league }}" placeholder="Event League">
        </p>
    </div>
</section>

<!-- Red/Blue Positioning Defaults -->
<section class="section">
    <div class="block">
        <h2 class="subtitle">ðŸ”´ðŸ”µ Red/Blue Positioning Defaults</h2>
        <p class="help">Set default red/blue positioning for all cages. Individual cages can override these settings during matches.</p>
    </div>
    <div class="columns">
        <div class="column">
            <div class="field">
                <label class="label">TrueFinals Slot Assignment</label>
                <div class="control">
                    <label class="checkbox">
                        <input type="checkbox" id="slots_swap_default" {% if arena_settings.red_blue_positioning and arena_settings.red_blue_positioning.slots_swap_default %}checked{% endif %}>
                        <strong>Swap TrueFinals slots by default</strong>
                    </label>
                </div>
                <p class="help">Check this if TrueFinals consistently has slot[0]=BLUE and slot[1]=RED instead of the expected slot[0]=RED and slot[1]=BLUE</p>
            </div>
        </div>
        <div class="column">
            <div class="field">
                <label class="label">Physical Robot Positions</label>
                <div class="control">
                    <label class="checkbox">
                        <input type="checkbox" id="physical_swap_default" {% if arena_settings.red_blue_positioning and arena_settings.red_blue_positioning.physical_swap_default %}checked{% endif %}>
                        <strong>Swap physical positions by default</strong>
                    </label>
                </div>
                <p class="help">Check this if robots typically enter the arena in opposite corners from what the timer displays show</p>
            </div>
        </div>
    </div>
    <div class="field">
        <div class="control">
            <button class="button is-primary" onclick="savePositioningDefaults()">
                Save Positioning Defaults
            </button>
        </div>
    </div>
</section>

<!-- Cage only metadata. -->
<section class="section">
    <div class="block">
        <h2 class="subtitle">Cages</h2>
    </div>
    <div class="block">
        <table class="table is-striped is-fullwidth">
            <thead>
                <th>Cage ID</th>
                <th>Cage Name</th>
            </thead>
            <tbody>
            {% for cage in arena_settings.tournament_cages %} {{ loop.counter }}
                <tr>
                    <td>
                        <input class="input" type="number" id="return_cage_id_row_{{ loop.index }}" placeholder="{{ cage.id }}" value="{{ cage.id }}">
                    </td>
                    <td>                    
                        <input class="input" type="text"  id="return_cage_name_row_{{ loop.index }}" placeholder="{{ cage.name }}" value="{{ cage.name }}">
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Event Tournament Setup -->
<section class="section">
    <div class="block">
        <h2 class="subtitle">TrueFinals Tournaments</h2>
    </div>
    <div class="block">
        <table class="table is-striped is-fullwidth">
            <thead>
                <th>Weightclass Name</th>
                <th>TrueFinals Key</th>
                <th>Weightclass (grams)</th>
            </thead>
            <tbody>
            {% for tournament in arena_settings.tournament_keys %} {{ loop.counter }}
                <tr>
                    <td>
                        <input class="input" type="text" id="return_tourneys_name_row_{{ loop.index }}" placeholder="{{ tournament.weightclass }}" value="{{ tournament.weightclass }}">
                    </td>
                    <td>                    
                        <input class="input" type="text"  id="return_tourneys_tf_key_row_{{ loop.index }}" placeholder="{{ tournament.id }}" value="{{ tournament.id }}">
                    </td>
                    <td>                    
                        <input class="input" type="number"  id="return_tourneys_weightclass_gms_row_{{ loop.index }}" placeholder="{{ tournament.weightInt }}" value="{{ tournament.weightInt }}">
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Event API Key Setup-->
<section class="section">
    <div class="block">
        <h2 class="subtitle">TrueFinals API Keys</h2>
    </div>
    <form method="POST">
        <div class="field">
            <label class="label" for="truefinals_user_id">TrueFinals User ID</label>
            <div class="control">
                <input class="input" type="text" id="truefinals_user_id" name="truefinals_user_id" value="{{ arena_secrets.truefinals.user_id }}" placeholder="Enter your TrueFinals user ID">
            </div>
        </div>
        <div class="field">
            <label class="label" for="truefinals_api_key">TrueFinals API Key</label>
            <div class="control has-icons-right">
                <input class="input" type="password" id="truefinals_api_key" name="truefinals_api_key" value="{{ arena_secrets.truefinals.api_key }}" placeholder="Enter your TrueFinals API key">
                <span class="icon is-small is-right" style="cursor: pointer;" onclick="togglePasswordVisibility('truefinals_api_key')">
                    <i class="fas fa-eye" id="truefinals_api_key_icon"></i>
                </span>
            </div>
        </div>
        <div class="field">
            <div class="control">
                <button class="button is-primary" type="submit">
                    Save TrueFinals Credentials
                </button>
                <a class="button is-light" href="/setup">
                    Setup Wizard
                </a>
            </div>
        </div>
    </form>
</section>
     
<!-- OBS Websocket Config-->
<section class="section">
    <div class="block">
        <h2 class="subtitle">OBS-Websocket Config</h2>
    </div>
    {% for obs_ws_setup in arena_secrets.obs_ws %}
    <div class="block">
        <p>
            <input class="input" type="text"  id="obs_ws_ip" value="{{ obs_ws_setup.uri }}" placeholder="URI (like 192.168.50.8)">
        </p>
    </div>
    <div class="block">
        <p>
            <input class="input" type="text" id="obs_ws_friendly_name" value="{{ obs_ws_setup.friendly_name }}" placeholder="Friendly Name">
        </p>
    </div>
    <div class="block">
        <p>
            <input class="input" type="text" id="obs_ws_api_token" value="{{ obs_ws_setup.token }}" placeholder="OBS WS Token (like dhfuisdhgfiusbnv)">
        </p>
    </div>
    <div class="block">
        <p>
            <input class="input" type="text" id="obs_ws_api_scene" value="{{ obs_ws_setup.scene }}" placeholder="Scene Name">
        </p>
    </div>
    {% endfor %}
</section>

<section class="section">
    <div class="block">
        <ul>
            <li>
                <h2 class="subtitle"> open source licenses (this section is a work in progress)</h2>
            </li>
            <h3 class="subtitle">whole site </h3>
            <ul>
                <li> this site makes use of flask, flask-socketio, and socket.io the upstream library.</li>
            </ul>
            <h3 class="subtitle"> timer screens </h3>
            <li>fonts used include <a href="#">Space Mono</a> and <a href="#">Glacial Indifference</a>, both distributed under the SIL Open Font License.</li>
            <li>JS libraries used include:</li>
            <ul>
                <li><a href="https://github.com/albert-gonzalez/easytimer.js/">easyTimer.js (licensed under <a href="https://opensource.org/license/mit">MIT License</a>)</li>
                <li><a href="https://github.com/STRML/textFit">textFit.js</a>, which is licensed under <a href="https://opensource.org/license/mit">MIT License</a></li>
            </ul>
        </ul>
    </div>
</section>


{% endblock %}

<script>
function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function savePositioningDefaults() {
    const slotsSwapDefault = document.getElementById('slots_swap_default').checked;
    const physicalSwapDefault = document.getElementById('physical_swap_default').checked;
    
    // Send POST request to save positioning defaults
    fetch('/settings/positioning', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            slots_swap_default: slotsSwapDefault,
            physical_swap_default: physicalSwapDefault
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const button = document.querySelector('button[onclick="savePositioningDefaults()"]');
            const originalText = button.innerHTML;
            button.innerHTML = 'âœ… Saved!';
            button.className = 'button is-success';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.className = 'button is-primary';
            }, 2000);
        } else {
            alert('Error saving positioning defaults: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving positioning defaults');
    });
}
</script>